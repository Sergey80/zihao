# https://stackoverflow.com/questions/44639182/nginx-proxy-amazon-s3-resources/44749584#44749584
# https://github.com/PressLabs/gs-proxy/blob/master/nginx.conf

proxy_cache_path           /tmp/ levels=1:2 keys_zone=gs_cache:10m max_size=500m inactive=60m use_temp_path=off;

server {
  listen 8000;
  server_name www.zihao.me;

  return 301 https://zihao.me$request_uri;
}

server {
    listen 8000 default_server;
    server_name zihao.me;

    charset utf-8;
    sendfile on;
    gzip on;

    # Logs
    # access_log off;
    # error_log /tmp/zihao.me.error.log;
    access_log /dev/stdout;
    error_log /dev/stdout;

    # Nameserver
    resolver                   8.8.8.8 valid=300s;
    resolver_timeout           10s;

    location / {
        rewrite /$ ${uri}index.html;

        proxy_http_version     1.1;
        proxy_set_header       Connection "";
        proxy_set_header       Authorization "";
        proxy_set_header       Host storage.googleapis.com;
        proxy_hide_header      X-GUploader-UploadID;
        proxy_hide_header      x-goog-generation;
        proxy_hide_header      x-goog-metageneration;
        proxy_hide_header      x-goog-stored-content-encoding;
        proxy_hide_header      x-goog-stored-content-length;
        proxy_hide_header      x-goog-meta-goog-reserved-file-mtime;
        proxy_hide_header      x-goog-hash;
        proxy_hide_header      x-goog-storage-class;
        proxy_hide_header      Accept-Ranges;
        proxy_hide_header      Alt-Svc;
        proxy_hide_header      Set-Cookie;
        proxy_ignore_headers   Set-Cookie;
        proxy_intercept_errors on;

        proxy_cache            gs_cache;
        proxy_cache_lock       on;
        proxy_cache_revalidate on;
        add_header             X-Cache-Status $upstream_cache_status;
        add_header             Cache-Control "max-age=31536000";

        proxy_pass             https://storage.googleapis.com/storage.zihao.me/zihao.me$uri;
    }
}
